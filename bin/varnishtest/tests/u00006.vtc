varnishtest "varnishlog coverage"

server s1 -repeat 2 {
	rxreq
	txresp
} -start

varnish v1 -vcl+backend {} -start

process p1 {
	exec varnishlog -n ${v1_name} -g raw -k 3 -w ${tmpdir}/vlog -A
} -start
shell {
	exec varnishlog -n ${v1_name} -D -P ${tmpdir}/vlog.pid \
	    -w ${tmpdir}/vlog.bin
}

shell -match "Usage: .*varnishlog <options>" \
	"varnishlog -h"
shell -expect "Copyright (c) 2006 Verdens Gang AS" \
	"varnishlog -V"
shell -err -match "Usage: .*varnishlog <options>" \
	"varnishlog extra"
shell -err -expect "Missing -w option" \
	"varnishlog -D"
shell -err -expect "Ambiguous grouping type: r" \
	"varnishlog -g r"
shell -err -expect "Unknown grouping type: foo" \
	"varnishlog -g foo"
shell -err -expect "-k: Invalid number 'foo'" \
	"varnishlog -k foo"
shell -err -expect "-L: Range error" \
	"varnishlog -L 0"

shell -err -expect {-i: "foo" matches zero tags} \
	"varnishlog -i foo"
shell -err -expect {-i: "Resp" is ambiguous} \
	"varnishlog -i Resp"
shell -err -expect {-i: Syntax error in "Re**sp"} \
	"varnishlog -i Re**sp"

shell -err -expect {-I: "foo" matches zero tags} \
	"varnishlog -I foo:bar"
shell -err -expect {-I: "Resp" is ambiguous} \
	"varnishlog -I Resp:bar"
shell -err -expect {-I: Regex error at position 4 (missing ))} \
	{varnishlog -I "(foo"}
shell -err -expect "-t: Invalid argument" \
	"varnishlog -t -1"
shell -err -expect "-t: Invalid argument" \
	"varnishlog -t foo"
shell -err -expect "-t: Invalid argument" \
	"varnishlog -t NaN"
shell -err -expect {-x: Syntax error in "**"} \
	{varnishlog -x "**"}
shell -err -expect {-X: Syntax error in "**"} \
	{varnishlog -X "**:bar"}
shell -err -expect "Cannot open output file (No such file or directory)" \
	{varnishlog -w /nonexistent/file}
shell -err -expect "Only one of -n and -r options may be used" \
	{varnishlog -n ${v1_name} -r ${v1_name}/_.vsm}

process p1 -wait
shell {grep -q "0 CLI" ${tmpdir}/vlog}
shell -match "0 CLI[ ]+- Wr 200 [0-9]+ PONG" \
	{varnishlog -n ${v1_name} -d -g raw -X "Wr 200 [0-9]+ [^P]"}

client c1 {
	txreq -url /foo
	rxresp
} -run

delay 1

shell "mv ${tmpdir}/vlog.bin ${tmpdir}/vlog.bin~"
shell "kill -HUP `cat ${tmpdir}/vlog.pid`"

client c1 {
	txreq -url /bar
	rxresp
} -run

delay 1

shell "kill `cat ${tmpdir}/vlog.pid`"

shell -match {^\*[ ]+<< Request\s+>>[ ]+1001[ ]+
-[ ]+1001 ReqURL[ ]+c /foo
$} \
	{varnishlog -r ${tmpdir}/vlog.bin~ -i ReqURL -v \
	-q "RespStatus == 200"}
shell -match "-[ ]+BereqURL[ ]+/bar" \
	"varnishlog -r ${tmpdir}/vlog.bin -x ReqURL"
shell -match {^\*[ ]+<< BeReq\s+>>[ ]+1005[ ]+
-[ ]+BereqURL[ ]+/bar
$} \
	"varnishlog -r ${tmpdir}/vlog.bin -b -C -I BAR"
