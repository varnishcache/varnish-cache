varnishtest "Test std.ip()"

server s1 {
	rxreq
	txresp
} -start

varnish v1 -vcl+backend {
	import std;

	sub vcl_deliver {
		set resp.http.foo0 = std.ip("8.8.8.*", client.ip);
		set resp.http.foo1 = std.ip("9.9.9.*", server.ip);
		set resp.http.foo2 = std.ip("1.2.3.*", "127.0.0.2");
		set resp.http.foo3 = std.ip("1.2.3.5", "127.0.0.3");
		set resp.http.foo4 = std.ip("2001:db8::", "[::1]");
		set resp.http.foo5 = std.ip("2001::db8::", "[::1]");
		set resp.http.foo6 = std.ip("localhost", "0.0.0.0", resolve = false);
		set resp.http.foo7 = std.ip("1.2.3.4", "0.0.0.0", resolve = false);
	}
} -start

client c1 {
	# Allow for DNS trouble with bogos domains
	timeout 60
	txreq
	rxresp
	expect resp.http.foo0 == "${localhost}"
	expect resp.http.foo1 == "${localhost}"
	expect resp.http.foo2 == "127.0.0.2"
	expect resp.http.foo3 == "1.2.3.5"
	expect resp.http.foo4 == "2001:db8::"
	expect resp.http.foo5 == "::1"
	expect resp.http.foo6 == "0.0.0.0"
	expect resp.http.foo7 == "1.2.3.4"
} -run
